#!/usr/bin/env bash
function __dotfiles_remove_path() {
    local -n __path_var=$1
    local path_to_remove=$2
    if [[ "$__path_var" = "$path_to_remove" ]]
    then
    __path_var=
    else
    __path_var=${__path_var//:$path_to_remove:/:} # delete instances in the middle
    __path_var=${__path_var#$path_to_remove:} # delete instance at the beginning
    __path_var=${__path_var%:$path_to_remove} # delete instance at the end
    fi
}

function dotfiles_remove_path() {
    __dotfiles_remove_path PATH "$1"
}

# https://stackoverflow.com/questions/73616907/how-to-use-node-in-wsl-zsh-exec-format-error-node/73616991#73616991
DOTFILES_REAL_NODE=$(
    dotfiles_remove_path "/home/$USER/bin"
    command which node
)
export DOTFILES_REAL_NODE

DOTFILES_SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
DOTFILES_EXECPATH_FIX="$DOTFILES_SCRIPT_DIR/node-execpath-fix.js"
export DOTFILES_NODE_WRAPPER="$DOTFILES_SCRIPT_DIR/node"

# Add preload script via NODE_OPTIONS so it propagates to child processes correctly
# Use --require (long form) because Next.js reformats -r incorrectly
if [[ -z "$NODE_OPTIONS" ]]; then
    export NODE_OPTIONS="--require=$DOTFILES_EXECPATH_FIX"
elif [[ "$NODE_OPTIONS" != *"$DOTFILES_EXECPATH_FIX"* ]]; then
    export NODE_OPTIONS="$NODE_OPTIONS --require=$DOTFILES_EXECPATH_FIX"
fi

# echo "$DOTFILES_REAL_NODE" >&2
DOTFILES_NODE_COMMAND=(
    "$(ldd "$DOTFILES_REAL_NODE" | grep ld-linux-x86-64.so.2 | awk '{print $1}')" --argv0 "$DOTFILES_REAL_NODE" "$DOTFILES_REAL_NODE" "$@"
)
echo "${DOTFILES_NODE_COMMAND[@]}" >&2
exec "${DOTFILES_NODE_COMMAND[@]}"
